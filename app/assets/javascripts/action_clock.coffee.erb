$(document).ready ->
  padWithZero = (i) ->
    if i < 10
      i = '0' + i
    i

  actionTime = ->
    now = new Date
    ending = new Date
    h = now.getHours()
    m = now.getMinutes()
    if m < 25
      ending.setHours h
      ending.setMinutes 25
    else if m < 30
      ending.setHours h
      ending.setMinutes 30
    else if m < 55
      ending.setHours h
      ending.setMinutes 55
    else
      ending.setHours h + 1
      ending.setMinutes 0
    ending

  updateStatus = (m) ->
    current_action = document.getElementById('time').dataset.current_action

    if m < 3 && !current_action
      document.getElementById('time').classList.remove 'focus', 'review', 'relax'
      document.getElementById('time').classList.add 'commit'
      return 'commit'
    else if m < 23 && !current_action
      document.getElementById('time').classList.remove 'commit', 'review', 'relax', 'focus'
      document.getElementById('time').classList.add 'toolate'
      return 'toolate'
    else if m < 23
      document.getElementById('time').classList.remove 'commit', 'review', 'relax'
      document.getElementById('time').classList.add 'focus'
      return 'focus'
    else if m < 25
      document.getElementById('time').classList.remove 'commit', 'focus', 'relax'
      document.getElementById('time').classList.add 'review'
      return 'review'
    else if m < 30
      document.getElementById('time').classList.remove 'commit', 'focus', 'review'
      document.getElementById('time').classList.add 'relax'
      return 'relax'
    return 'toolate'

  playSounds = (status, m, s) ->
    tick_volume = Number(document.getElementById('time').dataset.tick_volume) || 0
    warning_volume = Number(document.getElementById('time').dataset.warning_volume) || 0

    commit = new Audio("<%= asset_path('commit.wav') %>")
    tick = new Audio("<%= asset_path('tick.wav') %>")
    warning = new Audio("<%= asset_path('warning.wav') %>")
    bell = new Audio("<%= asset_path('bell.wav') %>")
    whistle = new Audio("<%= asset_path('whistle.wav') %>")

    commit.volume = tick_volume / 100
    tick.volume = tick_volume / 100
    warning.volume = warning_volume / 100
    bell.volume = warning_volume / 100
    whistle.volume = warning_volume / 100

    if s == 0 && m == 2 && status != 'relax'
      warning.play()
    else if s == 0 && m == 0 && status != 'relax'
      bell.play()
    else if s == 30 && m == 0 && status == 'relax'
      whistle.play()
    else if status == 'commit'
      commit.play()
    else if status != 'relax'
      tick.play()
    return

  startTime = ->
    now = new Date
    ending = actionTime()
    time_delta = ending - now
    m = now.getMinutes()

    if ending.getMinutes() == 0
      m_left = 59 - m
    else
      m_left = ending.getMinutes() - m - 1
    s_left = 60 - now.getSeconds() - 1

    status = updateStatus m_left

    playSounds(status, m_left, s_left)
    m_string = padWithZero(m_left)
    s_string = padWithZero(s_left)
    document.getElementById('time').innerHTML = m_string + ':' + s_string
    t = setTimeout((->
      startTime()
      return
    ), 1000)

  startTime()