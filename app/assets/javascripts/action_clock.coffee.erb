$(document).ready ->
  padWithZero = (i) ->
    if i < 10
      i = '0' + i
    i

  updateStatus = (seconds_up) ->
    current_action = document.getElementById('time').dataset.current_action

    if seconds_up < 3*60 && !current_action
      document.getElementById('time').classList.remove 'focus', 'review', 'relax'
      document.getElementById('time').classList.add 'commit'
      return 'commit'
    else if seconds_up < 23*60 && !current_action
      document.getElementById('time').classList.remove 'commit', 'review', 'relax', 'focus'
      document.getElementById('time').classList.add 'toolate'
      return 'toolate'
    else if seconds_up < 23*60
      document.getElementById('time').classList.remove 'commit', 'review', 'relax'
      document.getElementById('time').classList.add 'focus'
      return 'focus'
    else if seconds_up < 25*60
      document.getElementById('time').classList.remove 'commit', 'focus', 'relax'
      document.getElementById('time').classList.add 'review'
      return 'review'
    else if seconds_up < 30*60
      document.getElementById('time').classList.remove 'commit', 'focus', 'review'
      document.getElementById('time').classList.add 'relax'
      return 'relax'
    return 'something went wrong'

  playSounds = (status, m, s) ->
    tick_volume = Number(document.getElementById('time').dataset.tick_volume) || 0
    warning_volume = Number(document.getElementById('time').dataset.warning_volume) || 0

    commit = new Audio("<%= asset_path('commit.wav') %>")
    tick = new Audio("<%= asset_path('tick.wav') %>")
    warning = new Audio("<%= asset_path('warning.wav') %>")
    bell = new Audio("<%= asset_path('bell.wav') %>")
    whistle = new Audio("<%= asset_path('whistle.wav') %>")

    commit.volume = tick_volume / 100
    tick.volume = tick_volume / 100
    warning.volume = warning_volume / 100
    bell.volume = warning_volume / 100
    whistle.volume = warning_volume / 100

    if s == 0 && m == 2 && status != 'relax'
      warning.play()
    else if s == 0 && m == 0 && status != 'relax'
      bell.play()
    else if s == 30 && m == 0 && status == 'relax'
      whistle.play()
    else if status == 'commit'
      commit.play()
    else if status != 'relax'
      tick.play()
    return

  to_1800 = ->
    now = new Date
    temp = now.getMinutes() * 60 + now.getSeconds()
    if temp > 1800 then temp - 1800 else temp

  startTime = ->
    totalSecUp = to_1800()
    status = updateStatus(totalSecUp)

    totalSecDown = 1800 - totalSecUp
    actionSecDown = totalSecDown - 300
    minDown = if status == 'relax' then Math.floor(totalSecDown / 60) else Math.floor(actionSecDown / 60)
    secDown = totalSecDown % 60

    playSounds(status, minDown, secDown)

    m_string = padWithZero(minDown)
    s_string = padWithZero(secDown)
    document.getElementById('time').innerHTML = m_string + ':' + s_string
    t = setTimeout((->
      startTime()
      return
    ), 1000)

  startTime()